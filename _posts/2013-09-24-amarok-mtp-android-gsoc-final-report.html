---
layout: post
title: 'Amarok MTP (Android) GSoC: Final Report'
date: '2013-09-24T01:33:00.005+02:00'
author: strohel
tags:
- Amarok
- GSoC
- KDE
modified_time: '2013-09-24T01:33:49.618+02:00'
image: /images/2013-09-24-amarok-mtp-android-gsoc-final-report-GSoC2013-MTP-w14-betterconfigdialog.png
blogger_id: tag:blogger.com,1999:blog-4406477566892767740.post-2471090926838974802
blogger_orig_url: https://strohel.blogspot.com/2013/09/amarok-mtp-android-gsoc-final-report.html
---

<p>Ahoy, it is the time of the year again. The Google Summer of Code has just ended and here I come with the final report, joining my fellow Amarok GSoC student <a href="http://konradzemek.com/">Konrad Zemek</a> with his <a href="http://konradzemek.com/2013/09/23/the-end-of-gsoc-2013/">excellent posting</a>.</p>

<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-BTOXKB1FoYY/UkC9_BIKOnI/AAAAAAAAAxw/hbpMQ-B2Uak/s1600/GSoC2013-MTP-w14-betterconfigdialog.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="/images/2013-09-24-amarok-mtp-android-gsoc-final-report-GSoC2013-MTP-w14-betterconfigdialog.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Newer MTP device configuration dialog</td></tr></tbody></table><br />
Before I sum things up, let me quickly mention what I've done the very last week. In short, it was full of little features and polishing.<br />
<br />

<b>What I've done this week:</b><ul><li style="text-align: justify;">Fixed small glitches in playlist tooltips (properly escape HTML markup) and in MemoryMeta (show non-compilation albums with empty album artist).</li><li style="text-align: justify;">Implemented reading of the device folder structure, showing the actual track path as its location (the format is compatible with kio-mtp):</li></ul><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-A4QEoJ_FnY8/UkC_x_yZvKI/AAAAAAAAAx8/VUxdbmMsJRE/s1600/GSoC2013-MTP-w14-location.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="/images/2013-09-24-amarok-mtp-android-gsoc-final-report-GSoC2013-MTP-w14-location.png" /></a></div><ul style="text-align: justify;"><li>Implemented better fall-back when we fail to read device's storage entries (mostly because the Android device has its screen locker). It turns out that (at least Samsung's MTP stack) only blocks storage listing, but happily lists all the files and other entries. So we exploit that and infer storage ids from them. :-)</li><li>Added support for specifying the <i>Music folder</i>, the folder where new music is put into. I was trying a handful of approaches how to make this editable by user and ended up with an editable combo box that shows root items and provider nice completion for all folders. I had to implement full <i>QAbstractItemModel</i> of MTP folder because of this, but it was fun. ;-)</li><li>Finally added option to show only tracks under the <i>Music folder.</i> This is handy in order not to pick up misc music files like ringtones.</li></ul><b>Problems I've faced:</b><br />
<ul><li style="text-align: justify;">KCompletion is weird and subclassing it to my liking seems impossible because few methods are virtual and other ones use private d-pointer extensively. Fortunately QCompleter is much nicer and works (pretty well) even with a hierarchic model.</li><li style="text-align: justify;">MTP folder/storage model is weird. There are storages (e.g. <i>Internal memory</i> vs. <i>SD card</i>) and folders, so in order to remember "put things here" you have to save either <i>storage</i> or <i>folder</i> id <b>and</b> whether it is a storage or a folder. I guess this is because it was designed by <i>Microsoft...</i></li></ul><br />
<ul></ul><h3><span style="font-size: x-large;">Wrapping up</span></h3><br />
Let's see if the goals outlined in the <a href="https://google-melange.appspot.com/gsoc/project/google/gsoc2013/strohel/32001">initial project proposal</a> have been met:<ul><li style="text-align: justify;">Complete MTP Collection rewrite that removes the dependency on deprecated MediaDevice framework: <b>Check</b></li><li style="text-align: justify;">Actual communication with the device is strictly asynchronous (threaded) in order not to block the UI: <b>Check</b></li><li style="text-align: justify;">Zero-configuration device detection and enumeration, plug &amp; play: <b>Check</b></li><li style="text-align: justify;">Enumeration of tracks on the device along with their metadata: <b>Check</b></li><li style="text-align: justify;">Playback of tracks stored on devices with on-demand background loading: <b>Check</b></li><li style="text-align: justify;">Ability to transfer tracks out of and to MTP devices, with possibility to transcode: <b>Check</b></li><li style="text-align: justify;">Full playlist management (for devices that support them): <b>No, see below</b></li></ul><h3><span style="font-size: large;"><b>Future work</b></span></h3><ul style="text-align: justify;"><li>The problem with <b>playlists</b> is that the ones created in the most popular music player on Androids, the <i>Google Play Music</i>, aren't visible through the MTP API. It needs further investigation whether and how these could be accessed. In short-term I'll try to add support for traditional playlists, but I'll need external testers for that.</li><li>I haven't touched the <i>album API</i> at all, because my device (S III Mini with Android 4.2) happily ignores it and shows albums correctly without it. It might be however needed for proper album support on older devices. If it turns out this is the case during user testing, I'll add support for it.</li><li>Ability to specify custom file naming when uploading music would be nice.</li><li>Album art. My device displays album art embedded in file tags and I plan to add generic support to embed these to our transcoding/copying framework, but we could make use of the MTP <i>thumbnail API.</i></li></ul>My current plan is to add the last round of features and to do some final polishing, then submit a review request. As soon as the work is merged into master I'll request testing here. You can of course (and are encouraged to) test my work right away by checking out <a href="http://quickgit.kde.org/?p=clones%2Famarok%2Flaitl%2Famarok.git&amp;a=shortlog&amp;h=gsoc">gsoc branch of my personal Amarok clone repository</a>.
