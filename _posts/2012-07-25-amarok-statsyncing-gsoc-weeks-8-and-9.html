---
layout: post
title: 'Amarok StatSyncing GSoC: weeks 8 and 9'
date: '2012-07-25T14:02:00.001+02:00'
author: strohel
tags:
- amarok
- gsoc
- kde
modified_time: '2012-07-25T14:02:56.844+02:00'
thumbnail: http://1.bp.blogspot.com/-u_jTE1kFYwA/UA_OtabzAaI/AAAAAAAAAG4/lDe8HdIJuKM/s72-c/statsyncing-week-9.png
blogger_id: tag:blogger.com,1999:blog-4406477566892767740.post-4671314537171512278
blogger_orig_url: https://strohel.blogspot.com/2012/07/amarok-statsyncing-gsoc-weeks-8-and-9.html
---

Yes, I'm still working on <a href="http://www.google-melange.com/gsoc/project/google/gsoc2012/strohel/15001">my GSoC project about statistics synchronization in Amarok</a>. I've somehow skipped the last report (I was too deeply immersed in coding), to this one will be a bit more beefy. In short, I've fixed some bugs of the EngineController (the thing actually responsible for playback) that negatively affected Last.fm scrobbling first and then I've rewrote the class that actually scrobbles the tracks.<br />
<br />

<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-u_jTE1kFYwA/UA_OtabzAaI/AAAAAAAAAG4/lDe8HdIJuKM/s1600/statsyncing-week-9.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="/images/2012-07-25-amarok-statsyncing-gsoc-weeks-8-and-9-statsyncing-week-9.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Little side-effect of Last.fm improvements: correction suggestions</td></tr></tbody></table><br />
<b>What I've done in week 8:</b><br />
<ul><li>The <a href="https://git.reviewboard.kde.org/r/105488/">rather big patch series that fixed data-loss bugs</a> was <a href="http://quickgit.kde.org/index.php?p=amarok.git&amp;a=commit&amp;h=514d40d2b2fccf3951541be67d7be9534ec6d9a9">finally merged to master</a> to be included in Amarok 2.6 release candidate. Please give it a good testing.</li><li>Improved EngineController and Phonon interaction with regards to meta-data changes.</li><li>Improved MetaStream classes that represent audio streams. They now implement statistics (and some other fields) so that you can for example see how many songs you've listened to on particular stream. The statistics are forgotten on Amarok exit though.</li><li>Improved detection of "track finished playing" in EngineController. This fixes the "play count increased by 2" bug and may fix other issues with weird playlist playback.</li><li>Above 3 fixes (and a little more) are included in a <a href="https://git.reviewboard.kde.org/r/105610/">review request</a> that I intend to merge into master for 2.6 release candidate and in enginecontroller-fixes branch of my Amarok repository clone. This should be the last thing blocking the RC.</li></ul><b>What I've done the last week:</b><br />
<ul><li>Rebased my gsoc&nbsp; branch on top of liblastfm1 which is Harald Sitter's work on porting Amarok to liblastfm &gt;= 1.0. I need some its features and Amarok 2.7 will depend on it anyway.</li><li>Made EngineController detect some meta-data changes in streams and interpret them as song changes. This makes scrobbling possible even when listening to an infinite stream.</li><li>Cleaned up some Amarok code interfacing Last.fm to do it in more clean way.</li><li>Rewrote ScrobblerAdapter (responsible for scrobbling) to use all the new EngineController goodness. This allowed to ditch all the hacky code that tracked currently playing song by itself. This is also a preparation to splitting scrobbling code into controller/scrobbling service, which will allow to plug in different scrobbling back-ends (not just Last.fm) in future.</li><li>Fixed the MutiTrack API. Many streams (for example ones in the Internet category of the Media Sources pane) use it and it was a bit broken yielding broken meta-data updates, track-advancing, scrobbling etc.</li><li>Above fixes are published in my usual <a href="https://git.reviewboard.kde.org/r/105722/">gsoc review request</a> and are to be found in gsoc branch of my repository.</li></ul><b>Problems I've faced:</b><br />
<ul><li>EngineController code is convoluted. The worst thing is that there is a lot of code for special cases (multi-playback, multi-source, bounded-playback tracks) that is used infrequently. That code tends to break as it is little tested and sometimes not updated to reflect newest changes.</li><li>EngineController has to deal with different phonon back-ends and this is delicate. Phonon-vlc likes to emit aboutToFinish() twice in some cases while phonon-gstreamer likes to emit currentSourceChanged() twice and metaDataChanged() even more often (witch no reason). EngineController has to be written very carefully not to explode in case of such rough handling.</li></ul><b>What's next:</b><br />
<ul><li>Continuing the work on Last.fm scrobbling and synchronization. I'm a little bit behind the schedule with it currently, but the way is paved now.</li><li>I'll need to push some changes to liblastfm to make everything planned possible. The upstream is however pretty alive so this shouldn't be a big problem.</li></ul>You can test my work by pulling and <a href="http://blogs.fsfe.org/myriam/archives/87">building</a> <a href="http://quickgit.kde.org/index.php?p=clones%2Famarok%2Flaitl%2Famarok.git&amp;a=shortlog&amp;h=refs/heads/gsoc">gsoc branch</a> of <a href="http://quickgit.kde.org/?p=clones%2Famarok%2Flaitl%2Famarok.git&amp;a=summary">my Amarok git repository clone</a>, it already works quite well! I also publish weekly diffs with more technical details on KDE's review board which may be a more convenient way to review my code and to comment on it: <a href="https://git.reviewboard.kde.org/r/105055/">week 1</a> <a href="https://git.reviewboard.kde.org/r/105100/">week 2</a> <a href="https://git.reviewboard.kde.org/r/105219/">week 3</a> <a href="https://git.reviewboard.kde.org/r/105280/">week 4</a> (week 5 done in â†’) <a href="https://git.reviewboard.kde.org/r/105409/">week 6</a> <a href="https://git.reviewboard.kde.org/r/105488/">week 7 (master bugfix)</a> <a href="https://git.reviewboard.kde.org/r/105610/">week 8 (master bugfix)</a> <a href="https://git.reviewboard.kde.org/r/105722/">week 9</a>